---
title: "Dockerã«é–¢ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŸã¡"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker", "cache", "CI"]
published: false
---

# ã¯ã˜ã‚ã«
Dockerã‚’ç”¨ã„ãŸé–‹ç™ºã§ã¯ï¼Œé©åˆ‡ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç”¨ã„ã‚‹ã“ã¨ã§é«˜é€Ÿã«ãƒ“ãƒ«ãƒ‰ãƒ»é–‹ç™ºã§ãã¾ã™ï¼ãã®ãŸã‚ã®çŸ¥è¦‹ã¯æ§˜ã€…ãªè¨˜äº‹ã§å…±æœ‰ã•ã‚Œã¦ãŠã‚Šï¼Œã‚ã‚ŠãŒãŸã„é™ã‚Šã§ã™ï¼
ã—ã‹ã—ï¼Œã€ŒDockerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã¨è¨€ã£ã¦ã‚‚é–‹ç™ºæ™‚ã¨CIãƒ»CDã§ã¯è¡Œã†ã“ã¨ãŒé•ã„ã¾ã™ï¼
ã“ã®è¨˜äº‹ã§ã¯Dockerã‚’ç”¨ã„ãŸé–‹ç™ºã«ãŠã‘ã‚‹ï¼Œå„æ®µéšã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’ç¢ºèªã—ãŸã„ã¨æ€ã„ã¾ã™ï¼

ä¸»ã«ã€ŒDockerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã¨ã„ã†ã¨ä»¥ä¸‹ã®4ã¤ã«åˆ†é¡ã§ãã‚‹ã¨æ€ã„ã¾ã™ã®ã§ï¼Œãã‚Œãã‚Œã«ã¤ã„ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ï¼
1. Dockerã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ã‹ã™
	a. COPYãƒ»ADDã®é †ç•ª
	b. dockerignoreã®è¨­å®š
	c. ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
2. buidkitã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
	a. --mount=type=cache
3. CIãƒ»CDã«ãŠã„ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
	a. å‰å›ã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æŒã¡è¶Šã—ã¦ä½¿ã†
4. ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
	a. é–‹ç™ºè€…ãŒåˆã‚ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†

ã¾ãŸï¼Œèª¬æ˜ã®ãŸã‚ã«ç”¨ã„ã‚‹Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªãƒã‚¸ãƒˆãƒªã¯[ã“ã¡ã‚‰](https://github.com/masibw/go-docker-template)ã§ã™ï¼
ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯ä»Šå›èª¬æ˜ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå®Ÿè£…æ¸ˆã¿ã§ã™ã®ã§ï¼Œã‚ˆã‘ã‚Œã°å‚è€ƒã«ã—ã¦ãã ã•ã„ï¼

## ãƒ™ãƒ¼ã‚¹
ä»Šå›ã¯ä»¥ä¸‹ã®Dockerfileã‚’ç”¨ã„ã¦ä½œæˆã§ãã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ”¹å–„ã—ã¦ã„ãã¾ã™ï¼
```dockerfile
FROM golang:1.17.6

ENV CGO_ENABLED=0

WORKDIR /workdir

COPY . .
RUN go build -o app .

CMD ["/workdir/app"]
```

# Dockerã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ã‹ã™
Dockerã¯Dockerfileã«æ›¸ã‹ã‚ŒãŸå†…å®¹ã‚’è§£é‡ˆã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã£ã¦ãã‚Œã‚‹ã‚ã‘ã§ã™ãŒï¼Œ1ã¤1ã¤ã®å‘½ä»¤ã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå±¤ï¼‰ã¨ã—ï¼Œç©ã¿é‡ã­ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ï¼
ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¤‰æ›´ãŒãªã‘ã‚Œã°Dockerã¯ä»¥å‰ã®çµæœã‚’å†åˆ©ç”¨ã—ã¦ãã‚Œã¾ã™ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ï¼é€†ã«å¤‰æ›´ãŒã‚ã‚Œã°ï¼Œãã‚Œä»¥é™ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å†åº¦ä½œæˆã•ã‚Œã¾ã™ï¼
[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#minimize-the-number-of-layers)ã«ã‚ˆã‚‹ã¨ï¼Œã€ŒCOPYã€ã¨ã€ŒADDã€ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ™‚åˆ»ã‚„æ›´æ–°æ™‚åˆ»ã¯å«ã¾ãªã„ï¼‰ã‹ã‚‰ä½œã‚‰ã‚ŒãŸãƒãƒƒã‚·ãƒ¥ã‚’å…ƒã«ï¼Œå¤‰æ›´ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ï¼
ã€ŒRUNã€ã¯å˜ã«å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ï¼ˆå®Ÿè¡Œã«ã‚ˆã‚Šå¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ãªã„ï¼‰ãŒå¤‰åŒ–ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¾ã™ï¼

çµå±€ã®ã¨ã“ã‚ï¼Œãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å†åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒé‡è¦ãªã®ã§ãã®ãŸã‚ã®å·¥å¤«ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ï¼

## COPYãƒ»ADDã®é †ç•ª
COPYãƒ»ADDã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã¨ä»¥é™ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªããªã‚‹ã®ã§ï¼Œé †ç•ªãŒå¤§äº‹ã«ãªã£ã¦ãã¾ã™ï¼å¤‰æ›´ã®å°‘ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«COPYã—ã¾ã—ã‚‡ã†ï¼ä¸»ã«go.modã‚„yarn.lockãªã©ã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç®¡ç†ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè©²å½“ã™ã‚‹ã¯ãšã§ã™ï¼

```diff dockerfile
FROM golang:1.17.6

ENV CGO_ENABLED=0

WORKDIR /workdir

+COPY go.mod go.sum .
+RUN go mod download

COPY . .
RUN go build -o app .

CMD ["/workdir/app"]

```
ã“ã®ã‚ˆã†ã«æ›¸ãã¨ï¼Œã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã¦ã‚‚æ–°ãŸã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ãªã‘ã‚Œã°ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã¾ã™ï¼

## .dockerignoreã®æŒ‡å®š
DockerãŒãƒ“ãƒ«ãƒ‰æ™‚ã«å¿…è¦ã¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆDockerfileã‚„COPY/ADDã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ï¼‰ã®æƒ…å ±ã‚’ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‘¼ã³ã¾ã™ï¼
`docker build -t test-image .`ã¨å®Ÿè¡Œã—ãŸå ´åˆã¯`.`ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ï¼Œã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®å†…å®¹ãŒDockerã¸é€ã‚‰ã‚Œã¾ã™ï¼
ä¸å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨ï¼Œãƒ“ãƒ«ãƒ‰æ™‚é–“ã®å¢—åŠ ã‚„ç„¡é§„ãªå†ãƒ“ãƒ«ãƒ‰ã‚’å¼•ãèµ·ã“ã—ã¾ã™ï¼
ãã®ãŸã‚ï¼Œã€Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ“ãƒ«ãƒ‰ã«é–¢ä¿‚ã®ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆREADME.mdãªã©ï¼‰ã€ã¯å«ã¾ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ï¼
ã¾ãŸï¼ŒDockerã‚¤ãƒ¡ãƒ¼ã‚¸ã«ç§˜åŒ¿æƒ…å ±ã‚’å«ã‚€ã¨æµå‡ºã®æã‚ŒãŒã‚ã‚‹ã®ã§ã€Œç§˜åŒ¿æƒ…å ±ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ï¼‰ã€ã‚‚å«ã¾ãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ï¼ãƒ“ãƒ«ãƒ‰æ™‚ã«ä½¿ç”¨ã—ãŸã„å ´åˆã¯å¾Œè¿°ã™ã‚‹buildkitã‚’æœ‰åŠ¹ã«ã—ãŸä¸Šã§`--mount=type=secrets`ã‚’ç”¨ã„ã‚‹æ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ï¼[å‚è€ƒ](https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information)
`.dockerignore`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã™ã‚‹ã“ã¨ã§ãƒ“ãƒ«ãƒ‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦é€ã‚‰ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã§ãã¾ã™ï¼ï¼ˆ`.gitignore`ã®Dockerç‰ˆã¿ãŸã„ãªã‚„ã¤ã§ã™ã­ï¼‰

```
# ignore git files
.git/
.gitignore
.github/

# ignore docker-compose files
docker-compose.*.yml

# ignore environment files
.env*

# ignore document files
.docs/
*.md

# ignore editor settings
.idea/
.vscode/

# ignore log files
*.log
```
è©³ã—ã„è¨˜æ³•ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/engine/reference/builder/#dockerignore-file)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼
æ­£ã—ãè¨˜è¼‰ã§ãã¦ã„ã‚Œã°ï¼Œ`COPY . .`ã¨Dockerfileã«è¨˜è¼‰ã—ã¦ã‚‚ï¼Œãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ“ãƒ«ãƒ‰ã«é–¢ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã‚‹ã¯ãšã§ã™ï¼
## ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
å…·ä½“ä¾‹ã‚’è¦‹ãŸæ–¹ãŒã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã†ãŸã‚ï¼Œå…ˆã«ç¤ºã—ã¾ã™ï¼
```diff dockerfile
+FROM golang:1.17.6 AS build

ENV CGO_ENABLED=0

WORKDIR /workdir

COPY go.mod go.sum .
RUN go mod download

COPY . .
RUN go build -o app .

+FROM gcr.io/distroless/static-debian11:latest

+WORKDIR /workdir

+COPY --from=build /workdir/app /workdir/
CMD ["/workdir/app"]
```
1ã¤ã®Dockerfileã«2ã¤ã®`FROM`ãŒã‚ã‚Šã¾ã™ã­ï¼1ã¤ç›®ã®`golang:1.17.6`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ–¹ã¯ãƒ“ãƒ«ãƒ‰ç”¨ã«ãªã‚Šï¼Œãƒ“ãƒ«ãƒ‰çµæœã®ã¿ã‚’`gcr.io/distroless/static-debian11:latest`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹æ–¹ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ï¼ã“ã†ã™ã‚‹ã“ã¨ã§ï¼Œæœ€çµ‚çš„ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ä»¥å¤–å«ã¾ã‚Œãªããªã‚Šï¼Œè»½é‡ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

```diff
+go-docker-template          multi-stage     773107382a63   5 seconds ago       12MB
-go-docker-template          single-stage    7ef2476f0502   33 seconds ago      984MB
```
ã¾ãŸï¼Œä¸å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã¾ãªã„ãŸã‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚è‰¯ã„ã§ã™ï¼

:::message
gcr.io/distroless/static-debian11ã¯[distrolessã‚¤ãƒ¡ãƒ¼ã‚¸](https://github.com/GoogleContainerTools/distroless)ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ï¼Œéå¸¸ã«è»½é‡ãªä¸Šï¼Œã‚·ã‚§ãƒ«ã‚‚å«ã¾ãªã„ãŸã‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚è‰¯ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ï¼
:::

è‡ªèº«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å¤‰æ›´ãŒãªã‘ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ããŸã‚ï¼Œä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®é¢ã‹ã‚‰è¦‹ã¦ã‚‚åŠ¹æœçš„ã§ã™ï¼
```dockerfile
FROM node:latest AS yarn-base
# yarn install ã™ã‚‹

FROM ruby:latest AS gem-base
# bundle install ã™ã‚‹

FROM ruby:latest AS result
# yarn-baseã¨gem-baseã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã£ã¦ãã¦å®Ÿè¡Œã™ã‚‹
```
yarnã«é–¢ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ã¦ã‚‚gemã«å¤‰æ›´ãŒãªã‘ã‚Œã°æœ€å°é™ã®å®Ÿè¡Œã§æ¸ˆã¿ã¾ã™ã­ï¼
# buildkitã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
## buildkit
[buildkit](https://github.com/moby/buildkit)ã¨ã„ã†ã®ã¯ï¼ŒDocker buildã‚’æ›´ã«å¼·ãã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆã§ã™ï¼ã‚ˆã‚Šé«˜æ©Ÿèƒ½ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ãªã©ã‚’å«ã‚“ã§ã„ã¾ã™ï¼Docker 18.09ã‹ã‚‰å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ï¼ŒåŸºæœ¬çš„ãªæ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã™ãŒï¼Œå®Ÿé¨“çš„ãªæ©Ÿèƒ½ã¯ä½¿ç”¨ã™ã‚‹ã‹ãƒ»ã§ãã‚‹ã‹ã‚ˆãæ¤œè¨ã—ã¦ãã ã•ã„ï¼

### buildkitã‚’æœ‰åŠ¹ã«ã™ã‚‹
Docker version:18.09ä»¥é™ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼
1. ãƒ‡ãƒ¼ãƒ¢ãƒ³ã§æœ‰åŠ¹ã«ã™ã‚‹ï¼
#### macã‚„windows
Docker for Mac/Windowsã®è¨­å®šç”»é¢ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚Œã°OKã§ã™ï¼
![](/images/docker-preferences.png)
![](/images/docker-features.png)

ãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹ã‹ï¼Œè‡ªåˆ†ã§è¨˜è¼‰ã™ã‚‹ã¨è‰¯ã„ã¯ãšã§ã™ï¼ï¼ˆè¨­å®šã‚’å¹ãé£›ã°ã•ãªã„ã‚ˆã†ã«æ³¨æ„ï¼‰


#### Linuxãªã©
`/etc/docker/daemon.json`ã§buildkitã‚’æœ‰åŠ¹ã«ã—ã¦å†èµ·å‹•ã—ã¾ã—ã‚‡ã†ï¼
```
{ "features": { "buildkit": true } }
```

2. å®Ÿè¡Œæ™‚ã«`DOCKER_BUILDKIT=1`ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦æ¸¡ã™ï¼
```
DOCKER_BUILDKIT=1 docker build .
```


## buildx
[buildx](https://github.com/docker/buildx)ã¨ã„ã†ã®ã¯ï¼Œbuildkitã«å¯¾å¿œã—ãŸDocker CLIã®æ‹¡å¼µæ©Ÿèƒ½ã§ã™ï¼ï¼ˆã‚„ã‚„ã“ã—ã„...ï¼‰
æ­£ç›´ã¾ã æ·±ãç†è§£ã§ãã¦ã„ãªã„ã®ã§ã™ãŒï¼Œbuildxã¯æ™®é€šã®Docker buildã®æ©Ÿèƒ½ã‚’æœ‰ã—ã¦ã„ã‚‹ã®ã§ï¼Œ`docker buildx install`ã‚’å®Ÿè¡Œã—ï¼Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§buildxãŒä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ï¼

### buildkitã«ã‚ˆã‚‹Dockerfileã®æ‹¡å¼µè¨˜æ³•ã‚’ä½¿ã†
å¾Œè¿°ã™ã‚‹ `RUN --mount=type`ãªã©ã‚’ä½¿ã†ã«ã¯buildkitãŒå¿…è¦ã§ã™ï¼æ›´ã«ï¼Œ`# syntax=docker/dockerfile:1.3` ã¨Dockerfileã®å…ˆé ­ã«æ›¸ãå¿…è¦ãŒã‚ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ï¼ï¼ˆã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰å¿…è¦ã«ãªã‚‰ãªã„ã®ã‹ãªã©ï¼Œè©³ã—ã„ã“ã¨ã¯çŸ¥ã‚Šã¾ã›ã‚“...æœ‰è­˜è€…æ±‚ã‚€...)

## ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
ã“ã“ã§ã¯ï¼Œbuildkitã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ï¼ŒDockerfileã®æ‹¡å¼µè¨˜æ³•ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª¬æ˜ã—ã¾ã™ï¼

`RUN --mount=type=cache` ã¨ã„ã†è¨˜æ³•ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ï¼Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç”¨ã„ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãŒã©ã“ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã™ã‚‹ã‹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼
ä¾‹ãˆã°ï¼ŒGoã§ã‚ã‚Œã° `go env | grep CACHE`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«é–¢ä¿‚ã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã§ãã¾ã™ï¼
ã“ã†ã™ã‚‹ã“ã¨ã§ï¼Œ`go build`ã‚„`go mod download`ä»¥å‰ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¤‰æ›´ãŒã‚ã‚Šï¼Œå†åº¦å®Ÿè¡Œã•ã‚Œã‚‹éš›ã‚‚ä»¥å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ãŸå®Ÿè¡Œã«ãªã‚‹ã¯ãšã§ã™ï¼

```diff dockerfile
+# syntax = docker/dockerfile:1.3
FROM golang:1.17.6 AS build

ENV CGO_ENABLED=0

WORKDIR /workdir

COPY go.mod go.sum .
-RUN go mod download
+RUN --mount=type=cache,target=/go/pkg/mod go mod download

COPY . .
-RUN go build -o app .
+RUN --mount=type=cache,target=/root/.cache/go-build go build -o app .

FROM gcr.io/distroless/static-debian11:latest

WORKDIR /workdir

COPY --from=build /workdir/blog-server /workdir/
CMD ["/workdir/app"]
```

å®Ÿéš›ã«ï¼ŒGoã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å°‘ã—æ›¸ãå¤‰ãˆã¦ã‚‚ï¼Œãƒ“ãƒ«ãƒ‰ã¯å®Ÿè¡Œã•ã‚Œã¦ã‚‚é€Ÿããªã£ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ï¼
```diff
-[build 6/6] RUN go build -o app . 3.7s
+[build 6/6] RUN --mount=type=cache,target=/root/.cache/go-build go build -o app .  1.7s
```

ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚„è¨˜æ³•ã«ã¤ã„ã¦ã¯ [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md)ã§ç¢ºèªã§ãã¾ã™ï¼

# CIãƒ»CDã«ãŠã„ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒªãƒ¢ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
CIãƒ»CDã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ã‚‹å ´åˆã‚‚ï¼Œæ–°ãŸãªå ´æ‰€ã§ã®ãƒ“ãƒ«ãƒ‰ï¼ˆæ–°ãŸã«cloneã—ãŸå ´åˆãªã©ï¼‰ã®å ´åˆã‚‚ä½¿ã†æ©Ÿèƒ½ã¯åŒã˜ã§ï¼Œbuildkitã®cacheã‚’ç”¨ã„ã¾ã™ï¼
GitHub Actionsãªã©ã®CIãƒ»CDç’°å¢ƒã§ã¯å®Ÿè¡Œã™ã‚‹ãŸã³ã«ãƒ›ã‚¹ãƒˆãŒå¤‰ã‚ã‚‹ï¼ˆã¯ãšï¼‰ã§ã™ï¼ãã®ãŸã‚ï¼Œä½•ã‚‚è¨­å®šã—ãªã‘ã‚Œã°ä»Šã¾ã§èª¬æ˜ã—ã¦ããŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ¬¡å›ã®å®Ÿè¡Œã«æŒã¡è¶Šã•ã‚Œã¾ã›ã‚“ï¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã©ã“ã‹ã¸exportã—ï¼Œæ¬¡ã«å®Ÿè¡Œã™ã‚‹éš›ã«importã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼
ãã‚Œã«ã¯ï¼Œä¸Šè¿°ã—ãŸbuildkitã‚’ç”¨ã„ã¾ã™ï¼

buildkitãŒæä¾›ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¯ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ï¼ [å‚è€ƒ](https://github.com/moby/buildkit/tree/master#cache)

| åå‰ | èª¬æ˜ |
| ---- | ---- |
| inline | ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’1ã¤ã«ã—ã¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸pushã—ã¾ã™ï¼ | 
| registry | ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ¥ã€…ã«ã—ã¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸pushã—ã¾ã™ï¼ |
| local | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ï¼|
| gha | GitHub Actionsã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¸ä¿å­˜ã—ã¾ã™ï¼ |

ã¾ãŸï¼Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã¯2ã¤ã®ãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’ã—ã¦ã„ã‚‹å ´åˆã¯maxã‚’ä½¿ã„ãŸã„ã§ã™ã­ï¼

| åå‰ | èª¬æ˜ |
| ---- | ---- |
| min | æœ€çµ‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘exportã™ã‚‹ï¼ | 
| max | ä¸­é–“ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚å«ã‚“ã§å…¨ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’exportã™ã‚‹ï¼ |

GitHub Axctionsã—ã‹ä½¿ã‚ãªã„ã®ã§ã‚ã‚Œã°ghaã‚’ç”¨ã„ã‚‹ã®ãŒç°¡å˜ã§è‰¯ã„ã¨æ€ã„ã¾ã™ï¼
ã—ã‹ã—ï¼Œ2022å¹´2æœˆç¾åœ¨ï¼Œ
>docker driver currently only supports importing build cache from the registry.

[ã¨æ›¸ã„ã¦ã‚ã‚‹](https://github.com/docker/buildx/blob/master/docs/reference/buildx_build.md)ã®ã§ï¼Œæ–°ãŸã«cloneã—ãŸã¨ãã‚„ãƒ–ãƒ©ãƒ³ãƒã‚’åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ãŸã‘ã‚Œã°registryã‚’ä½¿ã†ã®ãŒè‰¯ã„ã¨æ€ã‚ã‚Œã¾ã™ï¼
ãŸã ï¼Œã“ã®è¾ºã¯ãƒãƒ¼ãƒ ã§ã©ã®ã‚ˆã†ã«é‹ç”¨ã™ã‚‹ã‹æ¬¡ç¬¬ã ã¨æ€ã„ã¾ã™ï¼åˆæœŸãƒ¡ãƒ³ãƒãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ã¦æ¬²ã—ã„ã¨è¨€ã†æ„å‘³ãªã‚‰mainãƒ–ãƒ©ãƒ³ãƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘pushã™ã‚Œã°è‰¯ã„ã§ã™ã—ï¼Œå„ãƒ–ãƒ©ãƒ³ãƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªã‚‰ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆãƒ»å‰Šé™¤ã™ã‚‹å¿…è¦ãŒå‡ºã¦ãã¾ã™ï¼
å€‹äººçš„ã«ã¯ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¾ã§ã¯æ±‚ã‚ã¦ãªã„ã®ã§ï¼Œmainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‚ã®ã‚’registryã«pushã™ã‚‹ã®ã§è‰¯ã„ã¨æ€ã£ã¦ã„ã¾ã™ï¼

ã¤ã¾ã‚Šï¼Œæ¬¡ã®ã‚ˆã†ãªmainãƒ–ãƒ©ãƒ³ãƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’registryã«pushã™ã‚‹jobã‚’ä½¿ã„ã¾ã™ï¼

GitHub Actionsã«ã¯build-push-actionã¨ã„ã†buildkitã‚’ä½¿ã£ãŸä¾¿åˆ©ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼
https://github.com/docker/build-push-action

```yaml
name: build
on:
  push:
    branches:
      - main

jobs:
  build:
    name: build app with cache
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: user/app:latest
          cache-from: type=registry,ref=user/app:buildcache
          cache-to: type=registry,ref=user/app:buildcache,mode=max
```

ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒªãƒ¢ãƒ¼ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ã«ã¯`--cache-from`ã‚’ä½¿ã„ï¼Œä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ï¼
```Bash
docker build --cache-from=user/app:buildcache -t user/app .
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Dockerã®ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã‚‚ï¼Œãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ï¼
``` bash
docker builder prune
```

# å‚è€ƒæ–‡çŒ®
- [Best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
- [Dockerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å…¨åŠ›ã§ä½¿ã„ã“ãªãã†](https://zenn.dev/kou64yama/articles/powerful-docker-build-cache)